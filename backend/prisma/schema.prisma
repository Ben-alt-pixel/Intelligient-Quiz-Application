// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      Role
  regNo     String?  @unique // For students only
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  materials        Material[]
  quizzes          Quiz[]
  quizSessions     QuizSession[]
  studentAnswers   StudentAnswer[]
  results          Result[]
  videoSubmissions VideoSubmission[]
  logs             Log[]

  @@index([email])
  @@index([role])
}

enum Role {
  STUDENT
  LECTURER
}

model Material {
  id        String   @id @default(cuid())
  title     String
  description String?
  content   String   @db.LongText
  fileUrl   String?
  fileType  String   // pdf, docx, txt
  lecturerId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  lecturer  User     @relation(fields: [lecturerId], references: [id], onDelete: Cascade)
  questions Question[]

  @@index([lecturerId])
}

model Quiz {
  id          String   @id @default(cuid())
  title       String
  description String?
  duration    Int      // in minutes
  passingScore Int     @default(60)
  lecturerId  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  lecturer      User           @relation(fields: [lecturerId], references: [id], onDelete: Cascade)
  questions     Question[]
  quizSessions  QuizSession[]
  results       Result[]

  @@index([lecturerId])
}

model Question {
  id          String   @id @default(cuid())
  text        String   @db.LongText
  type        QuestionType @default(MCQ)
  options     Json // JSON array of options
  correctAnswer Int
  explanation String?  @db.LongText // Optional explanation for lecturer
  difficulty  Difficulty @default(MEDIUM)
  quizId      String
  materialId  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  quiz          Quiz    @relation(fields: [quizId], references: [id], onDelete: Cascade)
  material      Material? @relation(fields: [materialId], references: [id], onDelete: SetNull)
  studentAnswers StudentAnswer[]

  @@index([quizId])
  @@index([materialId])
}

enum QuestionType {
  MCQ
  TRUE_FALSE
  SHORT_ANSWER
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

model QuizSession {
  id          String   @id @default(cuid())
  quizId      String
  studentId   String
  startTime   DateTime
  endTime     DateTime?
  status      SessionStatus @default(IN_PROGRESS)
  questions   String   @db.LongText // JSON array of randomized question IDs
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  quiz           Quiz            @relation(fields: [quizId], references: [id], onDelete: Cascade)
  student        User            @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentAnswers StudentAnswer[]
  videoSubmission VideoSubmission?

  @@index([quizId])
  @@index([studentId])
  @@index([status])
}

enum SessionStatus {
  IN_PROGRESS
  SUBMITTED
  GRADED
}

model StudentAnswer {
  id             String   @id @default(cuid())
  questionId     String
  sessionId      String
  studentId      String
  selectedAnswer String
  isCorrect      Boolean
  createdAt      DateTime @default(now())

  // Relations
  question      Question     @relation(fields: [questionId], references: [id], onDelete: Cascade)
  quizSession   QuizSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student       User         @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([questionId, sessionId, studentId])
  @@index([questionId])
  @@index([sessionId])
  @@index([studentId])
}

model Result {
  id           String   @id @default(cuid())
  quizId       String
  studentId    String
  score        Int
  totalQuestions Int
  percentage   Float
  passingStatus Boolean
  submittedAt  DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  quiz      Quiz   @relation(fields: [quizId], references: [id], onDelete: Cascade)
  student   User   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([quizId])
  @@index([studentId])
  @@unique([quizId, studentId])
}

model VideoSubmission {
  id          String   @id @default(cuid())
  sessionId   String   @unique
  studentId   String
  videoUrl    String
  uploadedAt  DateTime @default(now())
  duration    Int      // in seconds
  fileSize    Int      // in bytes

  // Relations
  quizSession QuizSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student     User        @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([studentId])
}

model Log {
  id        String   @id @default(cuid())
  userId    String
  action    String
  details   String?  @db.LongText
  ipAddress String?
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}
